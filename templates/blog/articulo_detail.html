{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

<title>{% block title %}{{ object.titulo }}{% endblock %}</title>

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/estilos_blog.css' %}">
{% endblock %}

{% block contenido %}

<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <!-- Título del artículo -->
        <h1>{{ object.titulo }}</h1>
        {% if object.subtitulo %}
            <p class="lead"><em>{{ object.subtitulo }}</em></p>
        {% endif %}

        <!-- Metadatos del artículo -->
        <div class="d-flex justify-content-between align-content-center mb-3">
            <small class="text-muted">
                Publicado el {{ object.fecha_publicacion|date:"d M Y" }}
                {% if object.autor %}
                    por <a href="{% url 'apps.users:detail_user' object.autor.pk %}">{{ object.autor.username }}</a>
                {% endif %}
                {% if object.categoria %}
                    en <a href="{% url 'apps.blog:articulo_por_categoria' object.categoria.nombre %}">{{ object.categoria.nombre }}</a>
                {% endif %}
            </small>
            {% if user.is_authenticated and (user == obect.autor or user == user.es_colaborador) %}
            <div>
                <a href="{% url 'apps.blog:editar_articulo' object.pk %}" class="btn btn-sm btn-warning">
                    <i class="fas fa-edit"></i> Editar
                </a>
                <a href="{% url 'apps.blog:eliminar_articulo' object.pk %}" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i> Eliminar
                </a>
            </div>
            {% endif %}
        </div>

        <hr>

        <div class="articulo_contenido">
            <!-- Lógica para mostrar la imagen (prioriza la URL sobre el archivo) -->
            {% if object.imagen_url %}
                <img src="{{ object.imagen_url }}" alt="{{ object.titulo }}" class="articulo-imagen img-fluid rounded mb-3">
            {% elif object.imagen_principal %}
                <img src="{{ object.imagen_principal.url }}" alt="{{ object.titulo }}" class="articulo-imagen img-fluid rounded mb-3">
            {% else %}
                <img src="https://placehold.co/900x400/2980b9/ffffff?text=Sin+Imagen" alt="Sin imagen disponible" class="articulo-imagen img-fluid rounded mb-3">
            {% endif %}

            <div class="articulo_contenido">
                <!-- El contenido del artículo, ahora con el filtro 'linebreaks' para mantener los saltos de línea -->
                {{ object.contenido|linebreaks }}
            </div>
        </div>
    
        <!-- Sección comentario -->
        <div class="mt-5">
            <h3>Comentarios</h3>
            <hr>
            {% if user.is_authentiated %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Deja tu comentario</h5>
                    <form action="{% url 'apps.blog:agrgar_comentario' object.pk %}" method="post">
                        {% csrf_token %}
                        {{ comentario_form|crispy:"bootstrap5"}}
                        <button type="submit" class="btn btn-primary mt-2">Publicar comentario</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                Debes <a href="{% url 'apps.users:login' %}?next={{ request.path }}">Iniciar Sesión</a> para dejar tu comentario
            </div>
            {% endif %}
        
            <!-- Lista de comentarios -->
            <div class="lista_comentarios">
                {% for comentario in object.comentarios.all %}
                    {% if comentario.aprobado or comentario.user == user %}
                    <div class="card mb-3 {% if not comentario.aprobado %}bg-ligth{% endif %}">
                        <div class="card-body">
                            <div class="d-flex juestify-content-between">
                                <h6 class="card-subtitle mb-2 text-muted">
                                    <a href="{% url 'apps.users:datail_user' comentario.usuario.pk %}">
                                        {{ comentario.usuario.username }}
                                    </a>
                                    <small>{{ comentario.fecha_creacion|date:'d M Y H:i' }}</small>
                                </h6>
                                {% if not comentario.aprobado %}
                                    <span class="badge bg-warning text-dark">Pendiente de aprobación</span>
                                {% endif %}
                            </div>
                            <div class="card-text">{{ comentario.texto|linebreaks }}</div>
                            {% if comentario.usuario == user or user.has_perm('blog.aprobar_comentario') %}
                            <div class="mt-2">
                                <a href="{% url 'apps.blog:editar_comentario' comentario.pk %}" 
                                    class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                                <a href="{% url 'apps.blog:eliminar_comentario' comentario.pk %}" 
                                    class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i> Eliminar
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% empty %}
                <div class="alert alert-secondary">
                    No hay comentarios aún. Se el primero en comentar.
                </div>
                {% endfor %}
            </div>
        </div>
        <a href="{% url 'apps.blog:lista_articulos' %}" class="btn btn-secondary">&larr; Volver a los articulos</a>
    </div>
</div>

{% endblock contenido %}